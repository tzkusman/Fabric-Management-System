{% extends 'base.html' %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h3><i class="fas fa-credit-card"></i> Supplier Credit Summary (Payables)</h3>
  <div>
    <a class="btn btn-outline-warning" href="/purchase-payments/pending"><i class="fas fa-clock"></i> Pending Payments</a>
    <a class="btn btn-outline-info" href="/purchase-payments/history"><i class="fas fa-history"></i> Payment History</a>
  </div>
</div>

<!-- Overall Summary Cards -->
<div class="row mb-4">
  <div class="col-md-3">
    <div class="card bg-danger text-white">
      <div class="card-body">
        <h5 class="card-title"><i class="fas fa-exclamation-triangle"></i> Total Payable</h5>
        <h2>₹{{ "%.2f"|format(total_credit) }}</h2>
        <p class="mb-0">We Owe Suppliers</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card bg-warning text-white">
      <div class="card-body">
        <h5 class="card-title"><i class="fas fa-users"></i> Suppliers</h5>
        <h2>{{ suppliers_with_credit }}</h2>
        <p class="mb-0">With Outstanding Credit</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card bg-info text-white">
      <div class="card-body">
        <h5 class="card-title"><i class="fas fa-file-invoice"></i> Invoices</h5>
        <h2>{{ total_pending_invoices }}</h2>
        <p class="mb-0">Unpaid/Partial</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card bg-success text-white">
      <div class="card-body">
        <h5 class="card-title"><i class="fas fa-chart-line"></i> Average Payable</h5>
        <h2>₹{{ "%.2f"|format(average_credit) }}</h2>
        <p class="mb-0">Per Supplier</p>
      </div>
    </div>
  </div>
</div>

<!-- Supplier Credit Details -->
{% if credit_summary %}
<div class="card">
  <div class="card-header bg-primary text-white">
    <h5 class="mb-0"><i class="fas fa-list"></i> Supplier-wise Payable Details</h5>
  </div>
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-hover">
        <thead class="table-dark">
          <tr>
            <th>#</th>
            <th>Supplier Name</th>
            <th>Total Purchases</th>
            <th>Pending Invoices</th>
            <th>Amount Paid</th>
            <th>Amount Due</th>
            <th>Payable %</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for idx in range(credit_summary|length) %}
          {% set supplier = credit_summary[idx] %}
          <tr class="{% if supplier.total_due > 10000 %}table-danger{% elif supplier.total_due > 5000 %}table-warning{% endif %}">
            <td>{{ idx + 1 }}</td>
            <td>
              <strong>{{ supplier.supplier_name }}</strong>
              {% if supplier.total_due > 10000 %}
                <span class="badge bg-danger ms-2">High Payable</span>
              {% elif supplier.total_due > 5000 %}
                <span class="badge bg-warning ms-2">Medium Payable</span>
              {% endif %}
            </td>
            <td>₹{{ "%.2f"|format(supplier.total_purchases) }}</td>
            <td><span class="badge bg-warning">{{ supplier.pending_count }}</span></td>
            <td><span class="text-success">₹{{ "%.2f"|format(supplier.amount_paid) }}</span></td>
            <td><strong class="text-danger">₹{{ "%.2f"|format(supplier.total_due) }}</strong></td>
            <td>
              {% set payable_percentage = (supplier.total_due / supplier.total_purchases * 100) if supplier.total_purchases > 0 else 0 %}
              <div class="progress" style="height: 25px;">
                <div class="progress-bar 
                  {% if payable_percentage > 75 %}bg-danger{% elif payable_percentage > 50 %}bg-warning{% else %}bg-info{% endif %}" 
                  role="progressbar" 
                  style="width: {{ payable_percentage }}%;" 
                  aria-valuenow="{{ payable_percentage }}" 
                  aria-valuemin="0" 
                  aria-valuemax="100">
                  {{ "%.1f"|format(payable_percentage) }}%
                </div>
              </div>
            </td>
            <td>
              <div class="btn-group btn-group-sm">
                <a class="btn btn-outline-primary" 
                  href="/purchase-payments/pending?supplier_id={{ supplier.supplier_id }}" 
                  title="View Pending Payments">
                  <i class="fas fa-eye"></i>
                </a>
                <a class="btn btn-outline-info" 
                  href="/ledger/supplier-summary?supplier_id={{ supplier.supplier_id }}" 
                  title="View Ledger">
                  <i class="fas fa-book"></i>
                </a>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
        <tfoot class="table-secondary">
          <tr>
            <th colspan="2" class="text-end">Totals:</th>
            <th>₹{{ "%.2f"|format(credit_summary|sum(attribute='total_purchases')) }}</th>
            <th><span class="badge bg-warning">{{ credit_summary|sum(attribute='pending_count') }}</span></th>
            <th class="text-success">₹{{ "%.2f"|format(credit_summary|sum(attribute='amount_paid')) }}</th>
            <th class="text-danger">₹{{ "%.2f"|format(credit_summary|sum(attribute='total_due')) }}</th>
            <th colspan="2"></th>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>
</div>

{% else %}
<div class="alert alert-success" role="alert">
  <i class="fas fa-check-circle"></i> <strong>Excellent!</strong> No outstanding payables. All purchases are fully paid!
</div>
{% endif %}

<!-- Payable Analysis Chart -->
{% if credit_summary %}
<div class="card mt-4">
  <div class="card-header bg-secondary text-white">
    <h5 class="mb-0"><i class="fas fa-chart-pie"></i> Top 5 Suppliers by Outstanding Payables</h5>
  </div>
  <div class="card-body">
    <div class="row">
      {% for supplier in credit_summary[:5] %}
      <div class="col-md-12 mb-3">
        <div class="d-flex justify-content-between align-items-center mb-1">
          <strong>{{ supplier.supplier_name }}</strong>
          <span class="text-danger">₹{{ "%.2f"|format(supplier.total_due) }}</span>
        </div>
        <div class="progress" style="height: 30px;">
          {% set percentage = (supplier.total_due / total_credit * 100) if total_credit > 0 else 0 %}
          <div class="progress-bar bg-danger" 
            role="progressbar" 
            style="width: {{ percentage }}%;" 
            aria-valuenow="{{ percentage }}" 
            aria-valuemin="0" 
            aria-valuemax="100">
            {{ "%.1f"|format(percentage) }}% of total payables
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>
{% endif %}

{% endblock %}
