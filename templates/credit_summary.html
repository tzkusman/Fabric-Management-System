{% extends 'base.html' %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h3><i class="fas fa-credit-card"></i> Customer Credit Summary</h3>
  <div>
    <a class="btn btn-outline-warning" href="/payments/pending"><i class="fas fa-clock"></i> Pending Payments</a>
    <a class="btn btn-outline-info" href="/payments/history"><i class="fas fa-history"></i> Payment History</a>
  </div>
</div>

<!-- Overall Summary Cards -->
<div class="row mb-4">
  <div class="col-md-3">
    <div class="card bg-danger text-white">
      <div class="card-body">
        <h5 class="card-title"><i class="fas fa-exclamation-triangle"></i> Total Credit</h5>
        <h2>₹{{ "%.2f"|format(total_credit) }}</h2>
        <p class="mb-0">Outstanding Balance</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card bg-warning text-white">
      <div class="card-body">
        <h5 class="card-title"><i class="fas fa-users"></i> Customers</h5>
        <h2>{{ customers_with_credit }}</h2>
        <p class="mb-0">With Outstanding Credit</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card bg-info text-white">
      <div class="card-body">
        <h5 class="card-title"><i class="fas fa-file-invoice"></i> Invoices</h5>
        <h2>{{ total_pending_invoices }}</h2>
        <p class="mb-0">Unpaid/Partial</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card bg-success text-white">
      <div class="card-body">
        <h5 class="card-title"><i class="fas fa-chart-line"></i> Average Credit</h5>
        <h2>₹{{ "%.2f"|format(average_credit) }}</h2>
        <p class="mb-0">Per Customer</p>
      </div>
    </div>
  </div>
</div>

<!-- Customer Credit Details -->
{% if credit_summary %}
<div class="card">
  <div class="card-header bg-primary text-white">
    <h5 class="mb-0"><i class="fas fa-list"></i> Customer-wise Credit Details</h5>
  </div>
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-hover">
        <thead class="table-dark">
          <tr>
            <th>#</th>
            <th>Customer Name</th>
            <th>Total Sales</th>
            <th>Pending Invoices</th>
            <th>Amount Paid</th>
            <th>Amount Due</th>
            <th>Credit %</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for idx, customer in enumerate(credit_summary, 1) %}
          <tr class="{% if customer.amount_due > 10000 %}table-danger{% elif customer.amount_due > 5000 %}table-warning{% endif %}">
            <td>{{ idx }}</td>
            <td>
              <strong>{{ customer.customer_name }}</strong>
              {% if customer.amount_due > 10000 %}
                <span class="badge bg-danger ms-2">High Credit</span>
              {% elif customer.amount_due > 5000 %}
                <span class="badge bg-warning ms-2">Medium Credit</span>
              {% endif %}
            </td>
            <td>₹{{ "%.2f"|format(customer.total_sales) }}</td>
            <td><span class="badge bg-warning">{{ customer.pending_count }}</span></td>
            <td><span class="text-success">₹{{ "%.2f"|format(customer.amount_paid) }}</span></td>
            <td><strong class="text-danger">₹{{ "%.2f"|format(customer.amount_due) }}</strong></td>
            <td>
              {% set credit_percentage = (customer.amount_due / customer.total_sales * 100) if customer.total_sales > 0 else 0 %}
              <div class="progress" style="height: 25px;">
                <div class="progress-bar 
                  {% if credit_percentage > 75 %}bg-danger{% elif credit_percentage > 50 %}bg-warning{% else %}bg-info{% endif %}" 
                  role="progressbar" 
                  style="width: {{ credit_percentage }}%;" 
                  aria-valuenow="{{ credit_percentage }}" 
                  aria-valuemin="0" 
                  aria-valuemax="100">
                  {{ "%.1f"|format(credit_percentage) }}%
                </div>
              </div>
            </td>
            <td>
              <div class="btn-group btn-group-sm">
                <a class="btn btn-outline-primary" 
                  href="/payments/pending?customer_id={{ customer.customer_id }}" 
                  title="View Pending Payments">
                  <i class="fas fa-eye"></i>
                </a>
                <a class="btn btn-outline-info" 
                  href="/ledger/customer-summary?customer_id={{ customer.customer_id }}" 
                  title="View Ledger">
                  <i class="fas fa-book"></i>
                </a>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
        <tfoot class="table-secondary">
          <tr>
            <th colspan="2" class="text-end">Totals:</th>
            <th>₹{{ "%.2f"|format(credit_summary|sum(attribute='total_sales')) }}</th>
            <th><span class="badge bg-warning">{{ credit_summary|sum(attribute='pending_count') }}</span></th>
            <th class="text-success">₹{{ "%.2f"|format(credit_summary|sum(attribute='amount_paid')) }}</th>
            <th class="text-danger">₹{{ "%.2f"|format(credit_summary|sum(attribute='amount_due')) }}</th>
            <th colspan="2"></th>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>
</div>

<!-- Export Options -->
<div class="mt-3">
  <a class="btn btn-outline-secondary" href="/export/credit-summary.csv">
    <i class="fas fa-download"></i> Export Credit Summary CSV
  </a>
  <a class="btn btn-outline-danger" href="/export/credit-summary.pdf">
    <i class="fas fa-file-pdf"></i> Export PDF Report
  </a>
</div>

{% else %}
<div class="alert alert-success" role="alert">
  <i class="fas fa-check-circle"></i> <strong>Excellent!</strong> No customers have outstanding credit. All sales are fully paid!
</div>
{% endif %}

<!-- Credit Analysis Chart (optional visual) -->
{% if credit_summary %}
<div class="card mt-4">
  <div class="card-header bg-secondary text-white">
    <h5 class="mb-0"><i class="fas fa-chart-pie"></i> Top 5 Customers by Outstanding Credit</h5>
  </div>
  <div class="card-body">
    <div class="row">
      {% for customer in credit_summary[:5] %}
      <div class="col-md-12 mb-3">
        <div class="d-flex justify-content-between align-items-center mb-1">
          <strong>{{ customer.customer_name }}</strong>
          <span class="text-danger">₹{{ "%.2f"|format(customer.amount_due) }}</span>
        </div>
        <div class="progress" style="height: 30px;">
          {% set percentage = (customer.amount_due / total_credit * 100) if total_credit > 0 else 0 %}
          <div class="progress-bar bg-danger" 
            role="progressbar" 
            style="width: {{ percentage }}%;" 
            aria-valuenow="{{ percentage }}" 
            aria-valuemin="0" 
            aria-valuemax="100">
            {{ "%.1f"|format(percentage) }}% of total credit
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>
{% endif %}

{% endblock %}
