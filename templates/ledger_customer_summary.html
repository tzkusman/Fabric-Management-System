{% extends 'base.html' %}
{% block content %}
<div class="ledger-header mb-4">
  <h2><i class="fas fa-users"></i> Customer Ledger Summary</h2>
  <p class="text-muted">Sales summary grouped by customers with transaction details</p>
</div>

<!-- Date Filter Panel -->
<div class="card mb-4 shadow-sm">
  <div class="card-header bg-info text-white">
    <h5 class="mb-0"><i class="fas fa-calendar-alt"></i> Date Range Filter</h5>
  </div>
  <div class="card-body">
    <form method="get" action="/ledger/customer-summary" class="row g-3">
      <div class="col-md-4">
        <label class="form-label fw-bold">From Date</label>
        <input type="date" class="form-control" name="date_from" 
          value="{{ filters.date_from or '' }}">
      </div>
      <div class="col-md-4">
        <label class="form-label fw-bold">To Date</label>
        <input type="date" class="form-control" name="date_to" 
          value="{{ filters.date_to or '' }}">
      </div>
      <div class="col-md-4 d-flex align-items-end gap-2">
        <button type="submit" class="btn btn-info text-white">
          <i class="fas fa-search"></i> Filter
        </button>
        <a href="/ledger/customer-summary" class="btn btn-outline-secondary">
          <i class="fas fa-redo"></i> Reset
        </a>
      </div>
    </form>
  </div>
</div>

<!-- Overall Summary -->
{% set total_customers = summary|length %}
{% set total_transactions = summary|sum(attribute='transaction_count') %}
{% set total_quantity = summary|sum(attribute='total_quantity') %}
{% set total_revenue = summary|sum(attribute='total_amount') %}

<div class="row mb-4">
  <div class="col-md-3">
    <div class="card text-center shadow-sm border-primary">
      <div class="card-body">
        <h6 class="text-muted mb-2">Active Customers</h6>
        <h2 class="text-primary mb-0">{{ total_customers }}</h2>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center shadow-sm border-info">
      <div class="card-body">
        <h6 class="text-muted mb-2">Total Transactions</h6>
        <h2 class="text-info mb-0">{{ total_transactions }}</h2>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center shadow-sm border-warning">
      <div class="card-body">
        <h6 class="text-muted mb-2">Total Quantity Sold</h6>
        <h2 class="text-warning mb-0">{{ total_quantity }} m</h2>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center shadow-sm border-success">
      <div class="card-body">
        <h6 class="text-muted mb-2">Total Revenue</h6>
        <h2 class="text-success mb-0">Rs. {{ total_revenue }}</h2>
      </div>
    </div>
  </div>
</div>

<!-- Customer Summary Table -->
<div class="card shadow-sm">
  <div class="card-header bg-light d-flex justify-content-between align-items-center">
    <h5 class="mb-0">Customer-wise Sales Summary</h5>
    <span class="badge bg-primary">{{ total_customers }} Customers</span>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover table-striped mb-0">
        <thead class="table-dark">
          <tr>
            <th>#</th>
            <th>Customer Name</th>
            <th>Contact</th>
            <th class="text-center">Transactions</th>
            <th class="text-end">Total Quantity (m)</th>
            <th class="text-end">Total Amount</th>
            <th class="text-center">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% if summary %}
            {% for customer in summary %}
            <tr>
              <td>{{ loop.index }}</td>
              <td>
                <strong>{{ customer.customer_name }}</strong>
                <br><small class="text-muted">ID: #{{ customer.customer_id }}</small>
              </td>
              <td>{{ customer.contact or 'N/A' }}</td>
              <td class="text-center">
                <span class="badge bg-info">{{ customer.transaction_count }}</span>
              </td>
              <td class="text-end"><strong>{{ customer.total_quantity }}</strong></td>
              <td class="text-end"><strong class="text-success">Rs. {{ customer.total_amount }}</strong></td>
              <td class="text-center">
                <a href="/ledger/sales?customer_id={{ customer.customer_id }}{% if filters.date_from %}&date_from={{ filters.date_from }}{% endif %}{% if filters.date_to %}&date_to={{ filters.date_to }}{% endif %}" 
                   class="btn btn-sm btn-outline-primary">
                  <i class="fas fa-eye"></i> View Details
                </a>
              </td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="7" class="text-center text-muted py-5">
                <i class="fas fa-users-slash fa-3x mb-3"></i><br>
                No customer sales found for the selected period.
              </td>
            </tr>
          {% endif %}
        </tbody>
        {% if summary %}
        <tfoot class="table-light">
          <tr>
            <th colspan="3" class="text-end">GRAND TOTAL:</th>
            <th class="text-center">{{ total_transactions }}</th>
            <th class="text-end">{{ total_quantity }} m</th>
            <th class="text-end text-success">Rs. {{ total_revenue }}</th>
            <th></th>
          </tr>
        </tfoot>
        {% endif %}
      </table>
    </div>
  </div>
</div>

<!-- Customer Rankings -->
{% if summary %}
<div class="row mt-4">
  <div class="col-md-6">
    <div class="card shadow-sm">
      <div class="card-header bg-warning">
        <h6 class="mb-0"><i class="fas fa-trophy"></i> Top 5 by Revenue</h6>
      </div>
      <div class="card-body">
        <ol class="list-group list-group-numbered">
          {% for customer in summary|sort(attribute='total_amount', reverse=true)[:5] %}
          <li class="list-group-item d-flex justify-content-between align-items-start">
            <div class="ms-2 me-auto">
              <div class="fw-bold">{{ customer.customer_name }}</div>
              <small class="text-muted">{{ customer.transaction_count }} transactions</small>
            </div>
            <span class="badge bg-success rounded-pill">Rs. {{ customer.total_amount }}</span>
          </li>
          {% endfor %}
        </ol>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card shadow-sm">
      <div class="card-header bg-info text-white">
        <h6 class="mb-0"><i class="fas fa-chart-line"></i> Top 5 by Quantity</h6>
      </div>
      <div class="card-body">
        <ol class="list-group list-group-numbered">
          {% for customer in summary|sort(attribute='total_quantity', reverse=true)[:5] %}
          <li class="list-group-item d-flex justify-content-between align-items-start">
            <div class="ms-2 me-auto">
              <div class="fw-bold">{{ customer.customer_name }}</div>
              <small class="text-muted">Rs. {{ customer.total_amount }}</small>
            </div>
            <span class="badge bg-primary rounded-pill">{{ customer.total_quantity }} m</span>
          </li>
          {% endfor %}
        </ol>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Quick Links -->
<div class="mt-4">
  <a href="/ledger/sales" class="btn btn-outline-success">
    <i class="fas fa-book"></i> Full Sales Ledger
  </a>
  <a href="/add_customer" class="btn btn-outline-primary">
    <i class="fas fa-user-plus"></i> Add Customer
  </a>
  <a href="/" class="btn btn-outline-secondary">
    <i class="fas fa-home"></i> Back Home
  </a>
</div>

<style>
.ledger-header {
  border-bottom: 3px solid #0dcaf0;
  padding-bottom: 15px;
}
.card {
  transition: transform 0.2s;
}
.card:hover {
  transform: translateY(-2px);
}
</style>
{% endblock %}
