{% extends 'base.html' %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h3><i class="fas fa-clock text-danger"></i> Pending Purchase Payments</h3>
  <div>
    <a class="btn btn-outline-primary" href="/purchases"><i class="fas fa-arrow-left"></i> Back to Purchases</a>
    <a class="btn btn-outline-info" href="/purchase-payments/credit-summary"><i class="fas fa-credit-card"></i> Supplier Credit</a>
  </div>
</div>

<!-- Filter Section -->
<div class="card mb-4">
  <div class="card-body">
    <form method="get" class="row g-3">
      <div class="col-md-4">
        <label class="form-label">Supplier</label>
        <select name="supplier_id" class="form-select">
          <option value="">All Suppliers</option>
          {% for s in suppliers %}
          <option value="{{ s.supplier_id }}" {% if request.query_params.get('supplier_id') == s.supplier_id|string %}selected{% endif %}>
            {{ s.name }}
          </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">From Date</label>
        <input type="date" name="start_date" class="form-control" value="{{ request.query_params.get('start_date', '') }}">
      </div>
      <div class="col-md-3">
        <label class="form-label">To Date</label>
        <input type="date" name="end_date" class="form-control" value="{{ request.query_params.get('end_date', '') }}">
      </div>
      <div class="col-md-2 d-flex align-items-end">
        <button type="submit" class="btn btn-primary w-100"><i class="fas fa-filter"></i> Filter</button>
      </div>
    </form>
  </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
  <div class="col-md-4">
    <div class="card bg-warning text-white">
      <div class="card-body">
        <h5 class="card-title"><i class="fas fa-exclamation-circle"></i> Total Pending</h5>
        <h2>{{ pending_purchases|length }}</h2>
        <p class="mb-0">Unpaid Invoices</p>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card bg-danger text-white">
      <div class="card-body">
        <h5 class="card-title"><i class="fas fa-rupee-sign"></i> Total Amount Due</h5>
        <h2>₹{{ "%.2f"|format(total_due) }}</h2>
        <p class="mb-0">We Owe Suppliers</p>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card bg-info text-white">
      <div class="card-body">
        <h5 class="card-title"><i class="fas fa-minus-circle"></i> Partial Payments</h5>
        <h2>{{ partial_count }}</h2>
        <p class="mb-0">Partially Paid</p>
      </div>
    </div>
  </div>
</div>

<!-- Pending Purchases Table -->
{% if pending_purchases %}
<div class="card">
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-hover">
        <thead class="table-dark">
          <tr>
            <th>Date</th>
            <th>Supplier</th>
            <th>Fabric Details</th>
            <th>Quantity</th>
            <th>Total Amount</th>
            <th>Amount Paid</th>
            <th>Amount Due</th>
            <th>Status</th>
            <th>Payment Method</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for purchase in pending_purchases %}
          <tr class="{% if purchase.payment_status == 'pending' %}table-warning{% else %}table-info{% endif %}">
            <td>{{ purchase.date }}</td>
            <td><strong>{{ purchase.supplier.name }}</strong></td>
            <td>
              <div>{{ purchase.fabric_type }}</div>
              <small class="text-muted">{{ purchase.fabric_code }} - {{ purchase.composition }}</small>
            </td>
            <td>{{ purchase.quantity_meters }} m</td>
            <td><strong>₹{{ "%.2f"|format(purchase.total_cost) }}</strong></td>
            <td>
              {% if purchase.amount_paid > 0 %}
                <span class="text-success">₹{{ "%.2f"|format(purchase.amount_paid) }}</span>
              {% else %}
                <span class="text-muted">₹0.00</span>
              {% endif %}
            </td>
            <td><strong class="text-danger">₹{{ "%.2f"|format(purchase.amount_due) }}</strong></td>
            <td>
              {% if purchase.payment_status == 'pending' %}
                <span class="badge bg-warning"><i class="fas fa-clock"></i> Pending</span>
              {% elif purchase.payment_status == 'partial' %}
                <span class="badge bg-info"><i class="fas fa-minus-circle"></i> Partial</span>
              {% endif %}
            </td>
            <td>{{ purchase.payment_method|title }}</td>
            <td>
              <div class="btn-group btn-group-sm">
                <a class="btn btn-success" href="/purchase-payments/record/{{ purchase.purchase_id }}" title="Record Payment">
                  <i class="fas fa-money-bill-wave"></i> Pay
                </a>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
        <tfoot class="table-secondary">
          <tr>
            <th colspan="4" class="text-end">Totals:</th>
            <th>₹{{ "%.2f"|format(pending_purchases|sum(attribute='total_cost')) }}</th>
            <th>₹{{ "%.2f"|format(pending_purchases|sum(attribute='amount_paid')) }}</th>
            <th class="text-danger">₹{{ "%.2f"|format(pending_purchases|sum(attribute='amount_due')) }}</th>
            <th colspan="3"></th>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>
</div>
{% else %}
<div class="alert alert-success" role="alert">
  <i class="fas fa-check-circle"></i> <strong>Great!</strong> No pending payments. All purchases are fully paid!
</div>
{% endif %}

{% endblock %}
