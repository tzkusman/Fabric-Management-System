{% extends 'base.html' %}
{% block content %}
<h3>Add Sale</h3>
{% if message %}
<div class="alert alert-success">{{ message }}</div>
{% endif %}
{% if error %}
<div class="alert alert-danger">{{ error }}</div>
{% endif %}
<form method="post" action="/add_sale" class="card p-3">
  <div class="mb-3">
    <label class="form-label">Select Your Company *</label>
    <select class="form-select" name="company_id" required>
      <option value="">-- Select Company --</option>
      {% for company in companies %}
      <option value="{{ company.company_id }}">{{ company.company_name }} - {{ company.phone }}</option>
      {% endfor %}
    </select>
    <small class="text-muted">Don't see your company? <a href="/register_company">Register it here</a></small>
  </div>
  <div class="mb-3">
    <label class="form-label">Customer</label>
    <select class="form-select" name="customer_id" required>
      {% for c in customers %}
      <option value="{{ c.customer_id }}">{{ c.name }} - {{ c.contact }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="mb-3">
    <label class="form-label">Fabric Type</label>
    {% if fabrics and fabrics | length > 0 %}
    <select class="form-select" name="fabric_type">
      {% for f in fabrics %}
      {# encode fabric_type||fabric_code||composition in the value so server can parse exact lot #}
      <option value="{{ (f.fabric_type or '') }}||{{ (f.fabric_code or '') }}||{{ (f.composition or '') }}">{{ f.fabric_type }} ({{ f.fabric_code }}) - {{ f.composition }} - avail: {{ f.balance_in_meters }}</option>
      {% endfor %}
    </select>
    {% else %}
    <input class="form-control" name="fabric_type" required />
    {% endif %}
  </div>
  <!-- Fabric Code and Composition are hidden - they're extracted from the fabric selection -->
  <div class="mb-3">
    <label class="form-label">Quantity (meters)</label>
    <input class="form-control" name="quantity_meters" type="number" step="0.01" required />
  </div>
  <div class="mb-3">
    <label class="form-label">Price per meter</label>
    <input class="form-control" name="price_per_meter" type="number" step="0.01" required />
  </div>
  <div class="mb-3">
    <label class="form-label">Tax</label>
    <div class="d-flex align-items-center gap-2">
      <div class="form-check">
        <input class="form-check-input" type="checkbox" name="apply_tax" id="apply_tax" checked 
          onchange="document.getElementById('tax_rate').disabled = !this.checked">
        <label class="form-check-label" for="apply_tax">Apply Tax</label>
      </div>
      <div class="input-group" style="max-width: 200px;">
        <input class="form-control" type="number" name="tax_rate" id="tax_rate" value="18" min="0" max="100" step="0.01" 
          onchange="this.value = Math.max(0, Math.min(100, this.value))"
          disabled>
        <span class="input-group-text">%</span>
      </div>
    </div>
  </div>

  <!-- Payment Section -->
  <div class="card bg-light mb-3">
    <div class="card-body">
      <h5 class="card-title"><i class="fas fa-money-bill-wave"></i> Payment Details</h5>
      
      <div class="row">
        <div class="col-md-6 mb-3">
          <label class="form-label">Payment Method</label>
          <select class="form-select" name="payment_method" id="payment_method">
            <option value="cash">Cash</option>
            <option value="credit">Credit (Pay Later)</option>
            <option value="bank">Bank Transfer</option>
            <option value="cheque">Cheque</option>
          </select>
        </div>
        
        <div class="col-md-6 mb-3">
          <label class="form-label">Payment Status</label>
          <select class="form-select" name="payment_status" id="payment_status" onchange="updatePaymentFields()">
            <option value="paid">Paid (Full)</option>
            <option value="partial">Partial Payment</option>
            <option value="pending">Pending (No Payment)</option>
          </select>
        </div>
      </div>

      <div class="mb-3" id="amount_paid_div" style="display: none;">
        <label class="form-label">Amount Paid</label>
        <input type="number" class="form-control" name="amount_paid" id="amount_paid" 
          placeholder="Enter amount paid" step="0.01" min="0">
        <small class="text-muted">Leave blank for full payment or enter partial amount</small>
      </div>
    </div>
  </div>

  <script>
    function updateTaxRateState() {
      const applyTaxCheckbox = document.getElementById('apply_tax');
      const taxRateInput = document.getElementById('tax_rate');
      taxRateInput.disabled = !applyTaxCheckbox.checked;
      if (!applyTaxCheckbox.checked) {
        taxRateInput.value = '18';
      }
    }
    
    function updatePaymentFields() {
      const paymentStatus = document.getElementById('payment_status').value;
      const amountPaidDiv = document.getElementById('amount_paid_div');
      const amountPaidInput = document.getElementById('amount_paid');
      
      if (paymentStatus === 'partial') {
        amountPaidDiv.style.display = 'block';
        amountPaidInput.required = true;
      } else {
        amountPaidDiv.style.display = 'none';
        amountPaidInput.required = false;
        if (paymentStatus === 'paid') {
          amountPaidInput.value = '';
        } else if (paymentStatus === 'pending') {
          amountPaidInput.value = '0';
        }
      }
    }
    
    // Set initial state when page loads
    document.addEventListener('DOMContentLoaded', function() {
      updateTaxRateState();
      updatePaymentFields();
    });
    
    // Update state when checkbox changes
    document.getElementById('apply_tax').onchange = updateTaxRateState;
  </script>

  <button class="btn btn-success btn-lg" type="submit"><i class="fas fa-check"></i> ADD SALE</button>
</form>
<p class="mt-3"><a href="/">Back home</a></p>
{% endblock %}
