{% extends 'base.html' %}
{% block content %}
<div class="card bg-light mb-4 shadow-sm">
  <div class="card-body">
    <h2 class="card-title mb-3"><i class="fas fa-bank"></i> Bank Statement</h2>
    <p class="card-text text-muted">Complete transaction history showing all credits (money in) and debits (money out)</p>
  </div>
</div>

<!-- Success Message -->
{% if request.query_params.get('added') %}
<div class="alert alert-success alert-dismissible fade show" role="alert">
  <i class="fas fa-check-circle"></i> <strong>Success!</strong> Bank entry has been recorded successfully.
  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endif %}

<!-- Filters -->
<div class="card mb-4">
  <div class="card-body">
    <form method="get" action="/bank/statement" class="row g-3">
      <div class="col-md-3">
        <label class="form-label">Transaction Type</label>
        <select class="form-select" name="type">
          <option value="">-- All Types --</option>
          <option value="credit" {% if filters.type == 'credit' %}selected{% endif %}>Credit (Money In)</option>
          <option value="debit" {% if filters.type == 'debit' %}selected{% endif %}>Debit (Money Out)</option>
        </select>
      </div>
      
      <div class="col-md-3">
        <label class="form-label">Status</label>
        <select class="form-select" name="status">
          <option value="">-- All Status --</option>
          <option value="pending" {% if filters.status == 'pending' %}selected{% endif %}>Pending</option>
          <option value="cleared" {% if filters.status == 'cleared' %}selected{% endif %}>Cleared</option>
          <option value="failed" {% if filters.status == 'failed' %}selected{% endif %}>Failed</option>
        </select>
      </div>
      
      <div class="col-md-3">
        <label class="form-label">From Date</label>
        <input type="date" class="form-control" name="date_from" value="{{ filters.date_from or '' }}">
      </div>
      
      <div class="col-md-3">
        <label class="form-label">To Date</label>
        <input type="date" class="form-control" name="date_to" value="{{ filters.date_to or '' }}">
      </div>
      
      <div class="col-12">
        <button type="submit" class="btn btn-primary"><i class="fas fa-search"></i> Filter</button>
        <a href="/bank/statement" class="btn btn-outline-secondary"><i class="fas fa-redo"></i> Reset</a>
      </div>
    </form>
  </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
  <div class="col-md-6">
    <div class="card border-success">
      <div class="card-body">
        <h5 class="card-title text-success"><i class="fas fa-arrow-down"></i> Total Credits (Money In)</h5>
        <h3 class="text-success mb-0">Rs. {{ "%.2f"|format(summary.total_credit) }}</h3>
        <small class="text-muted">Total amount received</small>
      </div>
    </div>
  </div>
  
  <div class="col-md-6">
    <div class="card border-danger">
      <div class="card-body">
        <h5 class="card-title text-danger"><i class="fas fa-arrow-up"></i> Total Debits (Money Out)</h5>
        <h3 class="text-danger mb-0">Rs. {{ "%.2f"|format(summary.total_debit) }}</h3>
        <small class="text-muted">Total amount paid</small>
      </div>
    </div>
  </div>
</div>

<div class="row mb-4">
  <div class="col-md-6">
    <div class="card bg-info text-white">
      <div class="card-body">
        <h5 class="card-title">Opening Balance</h5>
        <h3 class="mb-0">Rs. {{ "%.2f"|format(summary.opening_balance) }}</h3>
      </div>
    </div>
  </div>
  
  <div class="col-md-6">
    <div class="card bg-primary text-white">
      <div class="card-body">
        <h5 class="card-title"><i class="fas fa-wallet"></i> Closing Balance</h5>
        <h3 class="mb-0">Rs. {{ "%.2f"|format(summary.closing_balance) }}</h3>
        <small>Net Position</small>
      </div>
    </div>
  </div>
</div>

<!-- Bank Statement Table -->
<div class="card">
  <div class="card-header bg-primary text-white">
    <h5 class="mb-0">
      <i class="fas fa-table"></i> Transaction Details ({{ summary.transaction_count }} transactions)
    </h5>
  </div>
  <div class="table-responsive">
    <table class="table table-hover mb-0">
      <thead class="table-light sticky-top">
        <tr>
          <th>#</th>
          <th>Date & Time</th>
          <th>Type</th>
          <th>Description</th>
          <th>Amount</th>
          <th>Account</th>
          <th>Reference</th>
          <th>Status</th>
          <th>Method</th>
        </tr>
      </thead>
      <tbody>
        {% if statements %}
          {% for stmt in statements %}
          <tr class="{% if stmt.transaction_type == 'credit' %}table-success{% else %}table-danger{% endif %}">
            <td><strong>{{ stmt.statement_id }}</strong></td>
            <td>{{ stmt.transaction_date.strftime('%Y-%m-%d %H:%M') }}</td>
            <td>
              {% if stmt.transaction_type == 'credit' %}
                <span class="badge bg-success"><i class="fas fa-arrow-down"></i> Credit</span>
              {% else %}
                <span class="badge bg-danger"><i class="fas fa-arrow-up"></i> Debit</span>
              {% endif %}
            </td>
            <td>
              <strong>{{ stmt.description }}</strong>
              {% if stmt.reconciliation_notes %}
                <br><small class="text-muted">{{ stmt.reconciliation_notes }}</small>
              {% endif %}
            </td>
            <td class="font-weight-bold">
              {% if stmt.transaction_type == 'credit' %}
                <span class="text-success">+Rs. {{ "%.2f"|format(stmt.amount) }}</span>
              {% else %}
                <span class="text-danger">-Rs. {{ "%.2f"|format(stmt.amount) }}</span>
              {% endif %}
            </td>
            <td>{{ stmt.bank_account or '-' }}</td>
            <td><code>{{ stmt.reference_number or '-' }}</code></td>
            <td>
              {% if stmt.status == 'cleared' %}
                <span class="badge bg-success"><i class="fas fa-check"></i> Cleared</span>
              {% elif stmt.status == 'pending' %}
                <span class="badge bg-warning"><i class="fas fa-clock"></i> Pending</span>
              {% else %}
                <span class="badge bg-danger"><i class="fas fa-times"></i> Failed</span>
              {% endif %}
            </td>
            <td>{{ stmt.payment_method or '-' }}</td>
          </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="9" class="text-center text-muted py-4">
              <i class="fas fa-inbox"></i> No transactions found
            </td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
  <div class="card-footer bg-light">
    <a href="/bank/add-entry" class="btn btn-success btn-sm">
      <i class="fas fa-plus"></i> Add Manual Entry
    </a>
    <a href="/bank/export.csv?type={{ filters.type or '' }}&status={{ filters.status or '' }}&date_from={{ filters.date_from or '' }}&date_to={{ filters.date_to or '' }}" 
       class="btn btn-outline-secondary btn-sm">
      <i class="fas fa-download"></i> Export as CSV
    </a>
    <a href="/bank/dashboard" class="btn btn-outline-primary btn-sm">
      <i class="fas fa-chart-line"></i> View Dashboard
    </a>
  </div>
</div>

<div class="mt-3">
  <a href="/" class="btn btn-outline-secondary"><i class="fas fa-home"></i> Back to Home</a>
</div>

{% endblock %}
