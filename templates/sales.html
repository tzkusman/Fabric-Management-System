{% extends 'base.html' %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3><i class="fas fa-shopping-cart"></i> Sales History</h3>
  <div>
    <a class="btn btn-warning" href="/payments/pending"><i class="fas fa-clock"></i> Pending Payments</a>
    <a class="btn btn-info" href="/payments/history"><i class="fas fa-history"></i> Payment History</a>
  </div>
</div>

<div class="table-responsive">
  <table class="table table-hover">
    <thead class="table-dark">
      <tr>
        <th>Date</th>
        <th>Customer</th>
        <th>Fabric</th>
        <th>Code</th>
        <th>Composition</th>
        <th>Quantity</th>
        <th>Price/m</th>
        <th>Tax</th>
        <th>Total</th>
        <th>Payment Status</th>
        <th>Amount Paid</th>
        <th>Amount Due</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for s in sales %}
      <tr class="{% if s.payment_status == 'pending' %}table-warning{% elif s.payment_status == 'partial' %}table-info{% endif %}">
        <td>{{ s.date }}</td>
        <td>{{ s.customer.name }}</td>
        <td>{{ s.fabric_type }}</td>
        <td>{{ s.fabric_code }}</td>
        <td>{{ s.composition }}</td>
        <td>{{ s.quantity_meters }} m</td>
        <td>₹{{ "%.2f"|format(s.price_per_meter) }}</td>
        <td>
          {% if s.apply_tax %}
            <span class="badge bg-success">{{ s.tax_rate }}%: ₹{{ "%.2f"|format(s.tax) }}</span>
          {% else %}
            <span class="badge bg-secondary">No Tax</span>
          {% endif %}
        </td>
        <td><strong>₹{{ "%.2f"|format(s.total_price_with_tax) }}</strong></td>
        <td>
          {% if s.payment_status == 'paid' %}
            <span class="badge bg-success"><i class="fas fa-check-circle"></i> Paid</span>
          {% elif s.payment_status == 'partial' %}
            <span class="badge bg-info"><i class="fas fa-minus-circle"></i> Partial</span>
          {% elif s.payment_status == 'pending' %}
            <span class="badge bg-warning"><i class="fas fa-clock"></i> Pending</span>
          {% endif %}
          <br>
          <small class="text-muted">{{ s.payment_method|title }}</small>
        </td>
        <td>
          {% if s.amount_paid > 0 %}
            <span class="text-success">₹{{ "%.2f"|format(s.amount_paid) }}</span>
          {% else %}
            <span class="text-muted">₹0.00</span>
          {% endif %}
        </td>
        <td>
          {% if s.amount_due > 0 %}
            <span class="text-danger"><strong>₹{{ "%.2f"|format(s.amount_due) }}</strong></span>
          {% else %}
            <span class="text-muted">₹0.00</span>
          {% endif %}
        </td>
        <td>
          <div class="btn-group btn-group-sm">
            <a class="btn btn-outline-secondary" href="/invoice/{{ s.sale_id }}" title="Download Invoice">
              <i class="fas fa-file-pdf"></i>
            </a>
            {% if s.payment_status in ['pending', 'partial'] %}
              <a class="btn btn-outline-success" href="/payments/record/{{ s.sale_id }}" title="Record Payment">
                <i class="fas fa-money-bill-wave"></i>
              </a>
            {% endif %}
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="mt-3">
  <a class="btn btn-outline-secondary" href="/export/sales.csv"><i class="fas fa-download"></i> Export CSV</a>
</div>
{% endblock %}
